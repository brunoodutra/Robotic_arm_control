
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>tutorial_ident_multivar</title><meta name="generator" content="MATLAB 9.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2021-04-19"><meta name="DC.source" content="tutorial_ident_multivar.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Aquisi&ccedil;&atilde;o e identifica&ccedil;&atilde;o multivar:</a></li><li><a href="#2">Etapa 1: Sinal de entrada do modelo</a></li><li><a href="#3">Etapa 2): Conex&atilde;o entre MATLAB, arduino e a planta</a></li><li><a href="#4">Visualisa&ccedil;&atilde;o do Datalog</a></li><li><a href="#5">Etapa 3) Ajuste do datalog</a></li><li><a href="#6">Etapa 4) Identifica&ccedil;&atilde;o do modelo</a></li><li><a href="#7">Etapa 4.2) Modelo Arx</a></li><li><a href="#8">Etapa 4.2) Minimos quadrados SS</a></li><li><a href="#9">Etapa 4.3) Subespa&ccedil;o n4sid</a></li><li><a href="#10">Etapa 5) Avalia&ccedil;&atilde;o das respostas do modelo_1 e modelo_2 identificados</a></li><li><a href="#11">Etapa 5.2 valida&ccedil;&atilde;o do modelo 1</a></li><li><a href="#12">Etapa 5.1 valida&ccedil;&atilde;o do modelo 2</a></li><li><a href="#13">Etapa 5.2 valida&ccedil;&atilde;o do modelo 3</a></li></ul></div><h2 id="1">Aquisi&ccedil;&atilde;o e identifica&ccedil;&atilde;o multivar:</h2><p>Tutorial para a aquisi&ccedil;&atilde;o de datalog e identifica&ccedil;&atilde;o de modelo em Espa&ccedil;o de estados ME.ENG.Bruno Gomes Dutra</p><pre class="codeinput">clear <span class="string">all</span>; close <span class="string">all</span>; clc;
</pre><h2 id="2">Etapa 1: Sinal de entrada do modelo</h2><p>Vetor de entrada do modelo, pode ser um sinal quadrado, uma entrada ao degrau ou at&eacute; mesmo um impulso. Obs: &egrave; interessante tamb&eacute;m adicionar um sinal PRBS.</p><pre class="codeinput"><span class="comment">% Esse sinal &eacute; utilizado para acionar os atuadores com o objetivo de medir</span>
<span class="comment">% posteriormente o sinal de sa&iacute;da</span>

u1(1:25)=0; u1(26:200)=2; u1(201:410)=4;  u1(411:620)=0;
<span class="comment">% Para o caso de um sistema Multivar, com v&aacute;rias entradas e sa&iacute;das</span>
<span class="comment">% Podemos atribuir mais entradas, ex: u2, u3, u4 ... uN</span>
nit = length(u1); <span class="comment">% numero de intera&ccedil;&otilde;es com base no tamanho de u.</span>
u_prbs=create_prbs(0,0.2,0 ,9, 1, nit,1);
u1=u1+u_prbs;
<span class="comment">% Para um bra&ccedil;o rob&oacute;tico com 6 servos tem-se :</span>
u2=u1; u3=u1; u4=u1; u5=u1; u6=u1;


<span class="comment">% Tempo de amostragem utilizado para aquisi&ccedil;&atilde;o e pro controle</span>
  Ts = 0.05; <span class="comment">% 0.05 segundos &eacute; recomend&aacute;vel para uma comunica&ccedil;&atilde;o est&aacute;vel entre arduino e o matlab</span>
</pre><h2 id="3">Etapa 2): Conex&atilde;o entre MATLAB, arduino e a planta</h2><pre class="codeinput">delete(instrfindall); <span class="comment">% fun&ccedil;&atilde;o para limpar comunica&ccedil;&otilde;es serias existentes</span>
daqduino_start(<span class="string">'COM13'</span>,9600); <span class="comment">% Inicia a comunica&ccedil;&atilde;o pela porta COM(N).</span>
<span class="comment">%Obs: excolher a porta certa de acordo com o arduino</span>
<span class="keyword">for</span> i=1:3
daqduino_write_Mimo(0,0,0,0,0,Ts);
daqduino_read;
daqduino_write_Mimo(0,0,0,0,0,Ts);
<span class="keyword">end</span>

<span class="keyword">for</span> k=1:nit,
  Y(k,:)=daqduino_read; <span class="comment">% Leitura dos sinais de sa&iacute;da dos servos[ de 1 a 6]</span>
  <span class="comment">%%plota o sinal de sa&iacute;da em tempo real(Descomentar caso queira acompanhar o sinal)</span>
   <span class="comment">%plot(1:k,Y(:,1),'r' ,1:k,Y(:,2),'b',1:k,Y(:,3),'m',1:k,Y(:,4),'c',1:k,Y(:,4),'y',1:k,Y(:,6),'k');</span>
   <span class="comment">%drawnow</span>
  daqduino_write_Mimo(u1(k),u2(k),0,0,0,Ts); <span class="comment">%Manda o sinal de entrada para o arduino atuar nos atuadores</span>
<span class="keyword">end</span>
<span class="comment">% Y(1:10,:)=0;</span>
daqduino_end; <span class="comment">% End the connection to the DaqDuino device.</span>
</pre><pre class="codeoutput">DaqDuino started! Connection is open on port COM13
Available functions: daqduino_end(), daqduino_read(),
daqduino_write(u(k),Ts).
---------------------------------------------------
DAQ-Duino, 2013-2019.
Laboratory of Control and Systems (LACOS, ufpa.br).
Author:Bruno Gomes Dutra (brunodutra@ufpa.br).
---------------------------------------------------
DaqDuino ended.
---------------------------------------------------
DAQ-Duino, 2013-2015.
Laboratory of Control and Systems (LACOS, ufpa.br).
Group of Control and Systems (GCS, udesc.br).
Author: Prof. Antonio Silveira (asilveira@ufpa.br).
---------------------------------------------------
</pre><h2 id="4">Visualisa&ccedil;&atilde;o do Datalog</h2><pre class="codeinput">y1=  Y(:,1); <span class="comment">% sinal de sa&iacute;da 1 (primeiro servo)</span>
y2=  Y(:,2); <span class="comment">% Leitura do sinal de sa&iacute;da 2 (segundo servo)</span>
y3=  Y(:,3); <span class="comment">% Leitura do sinal de sa&iacute;da 3 (terceiro servo)</span>
y4=  Y(:,4); <span class="comment">% Leitura do sinal de sa&iacute;da 4 ...</span>
y5=  Y(:,5); <span class="comment">% Leitura do sinal de sa&iacute;da 5 ...</span>
y6=  Y(:,6); <span class="comment">% Leitura do sinal de sa&iacute;da 6 ...</span>

t=0:Ts:nit*Ts-Ts; <span class="comment">% Vetor de tempo com base em Ts</span>
figure(<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="string">'outerposition'</span>,[.4 .05 0.559 0.925])
subplot(211)
    plot(t,y1,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,2.2); hold
    plot(t,y2,<span class="string">'b'</span>,<span class="string">'linewidth'</span>,2.2);
    plot(t,y3,<span class="string">'m'</span>,<span class="string">'linewidth'</span>,2.2);
    plot(t,y4,<span class="string">'c'</span>,<span class="string">'linewidth'</span>,2.2);
    plot(t,y5,<span class="string">'y'</span>,<span class="string">'linewidth'</span>,2.2);
    plot(t,y6,<span class="string">'k'</span>,<span class="string">'linewidth'</span>,2.2);
    legend({<span class="string">'Posi&ccedil;&atilde;o angular 1'</span>,<span class="string">'Posi&ccedil;&atilde;o angular 2'</span>,<span class="string">'Posi&ccedil;&atilde;o angular 3'</span>,<span class="string">'Posi&ccedil;&atilde;o angular 4'</span>,<span class="string">'Posi&ccedil;&atilde;o angular 6'</span>});

    xlabel(<span class="string">'Tempo(s)'</span>)
    ylabel(<span class="string">'Tens&atilde;o(V)'</span>)
    <span class="comment">% legend('Ref_{for&ccedil;a}','For&ccedil;a');</span>
    title(<span class="string">'Datalog dos servos'</span>)
    set(gca,<span class="string">'fontsize'</span>,10);
    set(gca,<span class="string">'linewidth'</span>,1);

subplot(212)
    plot(t,u1,<span class="string">':r'</span>,<span class="string">'linewidth'</span>,2.5); hold <span class="string">on</span>;
    plot(t,u2,<span class="string">' :b'</span>,<span class="string">'linewidth'</span>,2.4);
    plot(t,u3,<span class="string">' :m'</span>,<span class="string">'linewidth'</span>,2.3);
    plot(t,u4,<span class="string">' :c'</span>,<span class="string">'linewidth'</span>,2.2);
    plot(t,u5,<span class="string">' :y'</span>,<span class="string">'linewidth'</span>,2.1);
    plot(t,u6,<span class="string">' :k'</span>,<span class="string">'linewidth'</span>,2.0);
    legend({<span class="string">'Servo 1'</span>,<span class="string">'Servo 2'</span>,<span class="string">'Servo 3'</span>,<span class="string">'Servo 4'</span>,<span class="string">'Servo 5'</span>,<span class="string">'Servo 6'</span>});

    title(<span class="string">'Atuadores'</span>)
    ylabel(<span class="string">'Tens&atilde;o(V)'</span>);
    xlabel(<span class="string">'Tempo(s)'</span>);
    set(gca,<span class="string">'fontsize'</span>,10);
    set(gca,<span class="string">'linewidth'</span>,1);
    save(<span class="string">"datalog.mat"</span>)
</pre><pre class="codeoutput">Current plot held
</pre><img vspace="5" hspace="5" src="tutorial_ident_multivar_01.png" alt=""> <h2 id="5">Etapa 3) Ajuste do datalog</h2><pre class="codeinput">U=[u1; u2; u3; u4; u5; u6]'; <span class="comment">% vetor com todas as entradas</span>

datalog = iddata(Y,U,Ts); <span class="comment">% vari&aacute;vel com os dados de entada e sa&iacute;da</span>
</pre><h2 id="6">Etapa 4) Identifica&ccedil;&atilde;o do modelo</h2><pre class="codeinput">ordem=2; <span class="comment">% escolha do projetista. O tamanho das matrizes(Ordem) vai interfirir na efic&aacute;cia do modelo</span>
numero_estados=6*ordem;
inputs=6
output=6
</pre><pre class="codeoutput">
inputs =

     6


output =

     6

</pre><h2 id="7">Etapa 4.2) Modelo Arx</h2><pre class="codeinput"><span class="comment">%identifica um modelo arx para cada reala&ccedil;&atilde;o de entrada e sa&iacute;da</span>
<span class="comment">% e suas respectivas rela&ccedil;&otilde;es de acoplamento</span>
<span class="comment">% ap&oacute;s isso encontra-se o seu equivalente em Espado de Estados (SS)</span>
d=size(datalog);
output=1;
inputs=1;
<span class="keyword">for</span> i= 1:d(2)
    sys(:,:,i) =armax(datalog(:,i,i),[ordem*ones(output,inputs), ordem*ones(output,inputs), zeros(output,inputs), zeros(inputs)]);
<span class="keyword">end</span>
<span class="keyword">for</span> i=1:d(2)
        Gz(i,i)=tf(tf(sys(:,:,i)));
<span class="keyword">end</span>
Gzmin=ss(Gz,<span class="string">'min'</span>);<span class="comment">% Para criar o modelo no espa&ccedil;o de estados</span>
[Ap,Bp,Cp,Dp,Ts]=ssdata(Gzmin);<span class="comment">% Para obter as matrizes A B C</span>
SS_model1=ss(Ap,Bp,Cp,Dp,Ts)
[Y1,X1]=lsim(SS_model1,U,t,zeros(size(Ap,1),1));
</pre><pre class="codeoutput">Warning: In the assignment "SYS(indices) = RHS," ignoring the input
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the output
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the input
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the output
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the input
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the output
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the input
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the output
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the input
names of RHS because of name conflicts with SYS. 
Warning: In the assignment "SYS(indices) = RHS," ignoring the output
names of RHS because of name conflicts with SYS. 

SS_model1 =
 
  A = 
            x1      x2      x3      x4      x5      x6      x7      x8
   x1   0.7906  0.3438       0       0       0       0       0       0
   x2      0.5       0       0       0       0       0       0       0
   x3        0       0  0.8066   0.358       0       0       0       0
   x4        0       0     0.5       0       0       0       0       0
   x5        0       0       0       0  0.8146  0.3488       0       0
   x6        0       0       0       0     0.5       0       0       0
   x7        0       0       0       0       0       0   0.665  0.2787
   x8        0       0       0       0       0       0     0.5       0
   x9        0       0       0       0       0       0       0       0
   x10       0       0       0       0       0       0       0       0
   x11       0       0       0       0       0       0       0       0
   x12       0       0       0       0       0       0       0       0
 
            x9     x10     x11     x12
   x1        0       0       0       0
   x2        0       0       0       0
   x3        0       0       0       0
   x4        0       0       0       0
   x5        0       0       0       0
   x6        0       0       0       0
   x7        0       0       0       0
   x8        0       0       0       0
   x9   0.6907  0.2631       0       0
   x10     0.5       0       0       0
   x11       0       0  0.8055  0.3491
   x12       0       0     0.5       0
 
  B = 
           u1     u2     u3     u4     u5     u6
   x1   0.125      0      0      0      0      0
   x2       0      0      0      0      0      0
   x3       0  0.125      0      0      0      0
   x4       0      0      0      0      0      0
   x5       0      0  0.125      0      0      0
   x6       0      0      0      0      0      0
   x7       0      0      0   0.25      0      0
   x8       0      0      0      0      0      0
   x9       0      0      0      0   0.25      0
   x10      0      0      0      0      0      0
   x11      0      0      0      0      0  0.125
   x12      0      0      0      0      0      0
 
  C = 
              x1         x2         x3         x4         x5         x6
   y1     0.1707   -0.02112          0          0          0          0
   y2          0          0     0.1022   -0.03445          0          0
   y3          0          0          0          0    0.09002   -0.03491
   y4          0          0          0          0          0          0
   y5          0          0          0          0          0          0
   y6          0          0          0          0          0          0
 
              x7         x8         x9        x10        x11        x12
   y1          0          0          0          0          0          0
   y2          0          0          0          0          0          0
   y3          0          0          0          0          0          0
   y4     0.2673   0.007942          0          0          0          0
   y5          0          0     0.2126  -0.001918          0          0
   y6          0          0          0          0     0.1269   -0.04365
 
  D = 
              u1         u2         u3         u4         u5         u6
   y1  -0.007679          0          0          0          0          0
   y2          0   -0.01203          0          0          0          0
   y3          0          0   -0.01251          0          0          0
   y4          0          0          0   0.007124          0          0
   y5          0          0          0          0  -0.001823          0
   y6          0          0          0          0          0   -0.01563
 
Sample time: 0.05 seconds
Discrete-time state-space model.

</pre><h2 id="8">Etapa 4.2) Minimos quadrados SS</h2><p>Utiliza-se a t&eacute;cnica de minimos quadrados recursivo (Recursive Least Square) para encontrar as matrizes A B e C do modelo</p><pre class="codeinput">[A,B,C,GAMA,W,V,AIC,fit,R2_,emq_]=ident_MQR_SS_master(Y,U,Ts,ordem)
SS_model2=ss(A,B,C,0,Ts); <span class="comment">% Modelo discreto</span>
<span class="comment">% [Y2,X2]=dlsim(A,B,C,0,U,[ones(numero_estados,1)*Y(1,1)]);</span>
[Y2,X2]=lsim(SS_model2,U,t,zeros(numero_estados,1));
</pre><pre class="codeoutput">Ruido de medida v(k): media=0.66809     0.67095     0.67317     0.66939      0.6692     0.67299; variancia=0.3196      0.3194     0.31952      0.3196     0.31948     0.31927

A =

  Columns 1 through 7

    0.1508    0.0136    0.1517   -0.0559    0.1500    0.0040    0.1265
   -0.4388    0.1951   -0.0520   -1.0396    0.1004    0.1396   -1.0189
    0.1375    0.0141    0.2957   -0.0579    0.3568    0.0015   -0.0429
   -0.3408    0.3413   -0.0637   -1.3103    0.0872    0.1651   -1.0454
    0.1331    0.0152    0.3531   -0.0597    0.4394    0.0015   -0.1100
   -0.2616    0.3290   -0.0076   -1.1996    0.0316   -0.0175   -1.0590
    0.1656    0.0135    0.0083   -0.0575   -0.0571    0.0067    0.2960
   -0.2201    0.2905   -0.0009   -1.2532    0.0385    0.1981   -1.1027
    0.1711    0.0128   -0.0491   -0.0559   -0.1397    0.0084    0.3634
   -0.1953    0.2920    0.0175   -1.2542    0.0552    0.1970   -1.0440
    0.1450    0.0149    0.2385   -0.0595    0.2735    0.0043    0.0253
   -0.1616    0.3216    0.0448   -1.2756    0.0764    0.1265   -1.0424

  Columns 8 through 12

    0.0208    0.1322   -0.0151    0.1572    0.0436
    0.3333   -0.9900   -0.1490    0.0941    0.7747
    0.0248   -0.1000   -0.0134    0.2390    0.0429
    0.4529   -1.0216   -0.2359    0.0608    0.8328
    0.0279   -0.1925   -0.0145    0.2713    0.0425
    0.6020   -1.0399   -0.3433    0.0200    0.8711
    0.0251    0.3636   -0.0248    0.0749    0.0474
    0.4594   -1.0409   -0.3640   -0.0227    0.8984
    0.0243    0.4557   -0.0287    0.0416    0.0490
    0.5618   -1.1055   -0.5938   -0.0992    1.0186
    0.0276   -0.0077   -0.0210    0.2053    0.0462
    0.5710   -1.1119   -0.3932   -0.1879    0.8642


B =

    0.0074    0.0074    0.0074    0.0074    0.0074    0.0074
    0.1303    0.1303    0.1303    0.1303    0.1303    0.1303
    0.0065    0.0065    0.0065    0.0065    0.0065    0.0065
    0.1312    0.1312    0.1312    0.1312    0.1312    0.1312
    0.0061    0.0061    0.0061    0.0061    0.0061    0.0061
    0.1307    0.1307    0.1307    0.1307    0.1307    0.1307
    0.0083    0.0083    0.0083    0.0083    0.0083    0.0083
    0.1324    0.1324    0.1324    0.1324    0.1324    0.1324
    0.0087    0.0087    0.0087    0.0087    0.0087    0.0087
    0.1336    0.1336    0.1336    0.1336    0.1336    0.1336
    0.0068    0.0068    0.0068    0.0068    0.0068    0.0068
    0.1342    0.1342    0.1342    0.1342    0.1342    0.1342


C =

  Columns 1 through 7

    1.0000   -0.0000   -0.0000    0.0000   -0.0000   -0.0000    0.0000
   -0.0000    0.0000    1.0000   -0.0000   -0.0000    0.0000    0.0000
   -0.0000    0.0000    0.0000   -0.0000    1.0000    0.0000    0.0000
    0.0000    0.0000   -0.0000   -0.0000    0.0000   -0.0000    1.0000
    0.0000   -0.0000   -0.0000    0.0000    0.0000   -0.0000    0.0000
    0.0000   -0.0000   -0.0000    0.0000    0.0000   -0.0000    0.0000

  Columns 8 through 12

   -0.0000   -0.0000    0.0000    0.0000   -0.0000
   -0.0000    0.0000    0.0000    0.0000   -0.0000
   -0.0000    0.0000   -0.0000   -0.0000    0.0000
   -0.0000   -0.0000    0.0000    0.0000   -0.0000
    0.0000    1.0000    0.0000    0.0000   -0.0000
   -0.0000    0.0000   -0.0000    1.0000   -0.0000


GAMA =

  Columns 1 through 7

    0.0567   -0.0239    0.0753    0.0075    0.0870    0.0178    0.0171
   -0.4254   -0.9270    0.0278    0.1015    0.3196    0.5060   -1.0599
    0.0565   -0.0265    0.0780    0.0040    0.0916    0.0158    0.0141
   -0.2941   -0.4872    0.0437   -0.1016    0.3200    0.4460   -1.0154
    0.0566   -0.0273    0.0782    0.0020    0.0927    0.0141    0.0131
   -0.2531   -0.3154    0.0643    0.2489    0.2481    0.0936   -1.0469
    0.0614   -0.0242    0.0754    0.0117    0.0840    0.0224    0.0240
   -0.1809   -0.2550    0.1003    0.3303    0.2814    0.4484   -1.0423
    0.0609   -0.0238    0.0736    0.0125    0.0816    0.0249    0.0240
   -0.1952   -0.2842    0.0831    0.3597    0.2687    0.5769   -1.0336
    0.0588   -0.0282    0.0773    0.0059    0.0896    0.0167    0.0161
   -0.1555   -0.3170    0.1165    0.3999    0.2980    0.6682   -1.0088

  Columns 8 through 12

   -0.0092    0.0101   -0.0308    0.0698   -0.0077
    0.0749   -1.1846   -0.3888    0.0347    0.0900
   -0.0052    0.0058   -0.0313    0.0719   -0.0057
   -0.0332   -1.1333   -0.4955    0.0358    0.1136
   -0.0019    0.0039   -0.0345    0.0719   -0.0026
   -0.1371   -1.1682   -0.6231   -0.0209    0.1804
   -0.0102    0.0179   -0.0443    0.0694   -0.0020
   -0.5608   -1.1243   -0.6946   -0.0260    0.1731
   -0.0140    0.0183   -0.0452    0.0673   -0.0001
   -0.0805   -1.2218   -1.0704   -0.1203   -0.0443
   -0.0034    0.0075   -0.0406    0.0708   -0.0004
    0.0424   -1.1999   -0.8791   -0.1732   -0.4607


W =

  Columns 1 through 7

    0.0042    1.6236    0.0043    1.6579    0.0045    1.6827    0.0045

  Columns 8 through 12

    1.7051    0.0046    1.6923    0.0044    1.7019


V =

    0.3196    0.3194    0.3195    0.3196    0.3195    0.3193


AIC =

    1.5799


fit =

   34.3514
  -20.4141
  -42.3760
   83.9921
   81.5779
    1.4928


R2_ =

   66.9974  -10.9629  -55.1894   98.0377   97.4021   25.7685


emq_ =

    1.5748

</pre><h2 id="9">Etapa 4.3) Subespa&ccedil;o n4sid</h2><p>T&eacute;cnica n4sid de identifica&ccedil;&atilde;o multivar</p><pre class="codeinput">[SYS3, X0]=n4sid(datalog,numero_estados); <span class="comment">% Identifica&ccedil;&atilde;o do modelo em Espa&ccedil;o de estados</span>
SS_model3=ss(SYS3.A,SYS3.B,SYS3.C,SYS3.D,Ts); <span class="comment">% Modelo discreto</span>
<span class="comment">% [Y3,X3]=lsim(SYS3.A,SYS3.B,SYS3.C,SYS3.D,U,t,zeros(numero_estados,1));</span>
[Y3,X3]=lsim(SS_model3,U,t,zeros(numero_estados,1));
</pre><h2 id="10">Etapa 5) Avalia&ccedil;&atilde;o das respostas do modelo_1 e modelo_2 identificados</h2><h2 id="11">Etapa 5.2 valida&ccedil;&atilde;o do modelo 1</h2><pre class="codeinput">figure(<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="string">'outerposition'</span>,[0 0 0.8 1])
title(<span class="string">"Valida&ccedil;&atilde;o do modelo2"</span>)
subplot(211),
    plot(t,y1,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,2); hold
    plot(t,Y1(:,1),<span class="string">'--r'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y2,<span class="string">'b'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y1(:,2),<span class="string">'--b'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y3,<span class="string">'m'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y1(:,3),<span class="string">'--m'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y4,<span class="string">'c'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y1(:,4),<span class="string">'--c'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y5,<span class="string">'y'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y1(:,5),<span class="string">'--y'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y6,<span class="string">'k'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y1(:,6),<span class="string">'--k'</span>,<span class="string">'linewidth'</span>,2.2);

    legend({<span class="string">'Y(1)_{real}'</span>,<span class="string">'Ys(1)_{simulado}'</span>,<span class="string">'Y(2)_{real}'</span>,<span class="string">'Ys(2)_{simulado}'</span>,<span class="string">'Y(3)_{real}'</span>,<span class="string">'Ys(3)_{simulado}'</span><span class="keyword">...</span>
        ,<span class="string">'Y(4)_{real}'</span>,<span class="string">'Ys(4)_{simulado}'</span>,<span class="string">'Y(5)_{real}'</span>,<span class="string">'Ys(5)_{simulado}'</span>,<span class="string">'Y(6)_{real}'</span>,<span class="string">'Ys(6)_{simulado}'</span> });

    ylabel(<span class="string">'sa&iacute;da real y(t)'</span>);
subplot(212),
    plot(t,U,<span class="string">'linewidth'</span>,2);
    ylabel(<span class="string">'entradas U(t)'</span>); xlabel(<span class="string">'Tempo (s)'</span>);
</pre><pre class="codeoutput">Current plot held
</pre><img vspace="5" hspace="5" src="tutorial_ident_multivar_02.png" alt=""> <h2 id="12">Etapa 5.1 valida&ccedil;&atilde;o do modelo 2</h2><pre class="codeinput">figure(<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="string">'outerposition'</span>,[0 0 0.8 1])
title(<span class="string">"Valida&ccedil;&atilde;o do modelo1"</span>)
subplot(211),
    plot(t,y1,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,2); hold
    plot(t,Y2(:,1),<span class="string">'--r'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y2,<span class="string">'b'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y2(:,2),<span class="string">'--b'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y3,<span class="string">'m'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y2(:,3),<span class="string">'--m'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y4,<span class="string">'c'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y2(:,4),<span class="string">'--c'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y5,<span class="string">'y'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y2(:,5),<span class="string">'--y'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y6,<span class="string">'k'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y2(:,6),<span class="string">'--k'</span>,<span class="string">'linewidth'</span>,2.2);

    legend({<span class="string">'Y(1)_{real}'</span>,<span class="string">'Ys(1)_{simulado}'</span>,<span class="string">'Y(2)_{real}'</span>,<span class="string">'Ys(2)_{simulado}'</span>,<span class="string">'Y(3)_{real}'</span>,<span class="string">'Ys(3)_{simulado}'</span><span class="keyword">...</span>
        ,<span class="string">'Y(4)_{real}'</span>,<span class="string">'Ys(4)_{simulado}'</span>,<span class="string">'Y(5)_{real}'</span>,<span class="string">'Ys(5)_{simulado}'</span>,<span class="string">'Y(6)_{real}'</span>,<span class="string">'Ys(6)_{simulado}'</span> });

    ylabel(<span class="string">'sa&iacute;da real y(t)'</span>);
subplot(212),
    plot(t,U,<span class="string">'linewidth'</span>,2);
    ylabel(<span class="string">'entradas U(t)'</span>); xlabel(<span class="string">'Tempo (s)'</span>);
</pre><pre class="codeoutput">Current plot held
</pre><img vspace="5" hspace="5" src="tutorial_ident_multivar_03.png" alt=""> <h2 id="13">Etapa 5.2 valida&ccedil;&atilde;o do modelo 3</h2><pre class="codeinput">figure(<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="string">'outerposition'</span>,[0 0 0.8 1])
title(<span class="string">"Valida&ccedil;&atilde;o do modelo2"</span>)
subplot(211),
    plot(t,y1,<span class="string">'r'</span>,<span class="string">'linewidth'</span>,2); hold
    plot(t,Y3(:,1),<span class="string">'--r'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y2,<span class="string">'b'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y3(:,2),<span class="string">'--b'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y3,<span class="string">'m'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y3(:,3),<span class="string">'--m'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y4,<span class="string">'c'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y3(:,4),<span class="string">'--c'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y5,<span class="string">'y'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y3(:,5),<span class="string">'--y'</span>,<span class="string">'linewidth'</span>,2.2);

    plot(t,y6,<span class="string">'k'</span>,<span class="string">'linewidth'</span>,2);
    plot(t,Y3(:,6),<span class="string">'--k'</span>,<span class="string">'linewidth'</span>,2.2);

    legend({<span class="string">'Y(1)_{real}'</span>,<span class="string">'Ys(1)_{simulado}'</span>,<span class="string">'Y(2)_{real}'</span>,<span class="string">'Ys(2)_{simulado}'</span>,<span class="string">'Y(3)_{real}'</span>,<span class="string">'Ys(3)_{simulado}'</span><span class="keyword">...</span>
        ,<span class="string">'Y(4)_{real}'</span>,<span class="string">'Ys(4)_{simulado}'</span>,<span class="string">'Y(5)_{real}'</span>,<span class="string">'Ys(5)_{simulado}'</span>,<span class="string">'Y(6)_{real}'</span>,<span class="string">'Ys(6)_{simulado}'</span> });

    ylabel(<span class="string">'sa&iacute;da real y(t)'</span>);
subplot(212),
    plot(t,U,<span class="string">'linewidth'</span>,2);
    ylabel(<span class="string">'entradas U(t)'</span>); xlabel(<span class="string">'Tempo (s)'</span>);
</pre><pre class="codeoutput">Current plot held
</pre><img vspace="5" hspace="5" src="tutorial_ident_multivar_04.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Aquisição e identificação multivar:
% Tutorial para a aquisição de datalog e identificação de modelo em Espaço
% de estados
% ME.ENG.Bruno Gomes Dutra
clear all; close all; clc;
%% Etapa 1: Sinal de entrada do modelo
% Vetor de entrada do modelo, pode ser um sinal quadrado, uma entrada ao
% degrau ou até mesmo um impulso. Obs: è interessante também adicionar um
% sinal PRBS. 

% Esse sinal é utilizado para acionar os atuadores com o objetivo de medir
% posteriormente o sinal de saída 

u1(1:25)=0; u1(26:200)=2; u1(201:410)=4;  u1(411:620)=0;
% Para o caso de um sistema Multivar, com várias entradas e saídas 
% Podemos atribuir mais entradas, ex: u2, u3, u4 ... uN 
nit = length(u1); % numero de interações com base no tamanho de u.
u_prbs=create_prbs(0,0.2,0 ,9, 1, nit,1);
u1=u1+u_prbs;
% Para um braço robótico com 6 servos tem-se : 
u2=u1; u3=u1; u4=u1; u5=u1; u6=u1;


% Tempo de amostragem utilizado para aquisição e pro controle
  Ts = 0.05; % 0.05 segundos é recomendável para uma comunicação estável entre arduino e o matlab

%% Etapa 2): Conexão entre MATLAB, arduino e a planta 

delete(instrfindall); % função para limpar comunicações serias existentes
daqduino_start('COM13',9600); % Inicia a comunicação pela porta COM(N).
%Obs: excolher a porta certa de acordo com o arduino
for i=1:3
daqduino_write_Mimo(0,0,0,0,0,Ts);
daqduino_read;
daqduino_write_Mimo(0,0,0,0,0,Ts);
end

for k=1:nit,
  Y(k,:)=daqduino_read; % Leitura dos sinais de saída dos servos[ de 1 a 6]
  %%plota o sinal de saída em tempo real(Descomentar caso queira acompanhar o sinal)
   %plot(1:k,Y(:,1),'r' ,1:k,Y(:,2),'b',1:k,Y(:,3),'m',1:k,Y(:,4),'c',1:k,Y(:,4),'y',1:k,Y(:,6),'k');
   %drawnow
  daqduino_write_Mimo(u1(k),u2(k),0,0,0,Ts); %Manda o sinal de entrada para o arduino atuar nos atuadores
end
% Y(1:10,:)=0;
daqduino_end; % End the connection to the DaqDuino device.

%% Visualisação do Datalog
y1=  Y(:,1); % sinal de saída 1 (primeiro servo)
y2=  Y(:,2); % Leitura do sinal de saída 2 (segundo servo)
y3=  Y(:,3); % Leitura do sinal de saída 3 (terceiro servo)
y4=  Y(:,4); % Leitura do sinal de saída 4 ...
y5=  Y(:,5); % Leitura do sinal de saída 5 ...
y6=  Y(:,6); % Leitura do sinal de saída 6 ...
 
t=0:Ts:nit*Ts-Ts; % Vetor de tempo com base em Ts
figure('units','normalized','outerposition',[.4 .05 0.559 0.925])
subplot(211)
    plot(t,y1,'r','linewidth',2.2); hold
    plot(t,y2,'b','linewidth',2.2);
    plot(t,y3,'m','linewidth',2.2);
    plot(t,y4,'c','linewidth',2.2);
    plot(t,y5,'y','linewidth',2.2);
    plot(t,y6,'k','linewidth',2.2);
    legend({'Posição angular 1','Posição angular 2','Posição angular 3','Posição angular 4','Posição angular 6'});

    xlabel('Tempo(s)')
    ylabel('Tensão(V)')
    % legend('Ref_{força}','Força');
    title('Datalog dos servos')
    set(gca,'fontsize',10);
    set(gca,'linewidth',1);

subplot(212)
    plot(t,u1,':r','linewidth',2.5); hold on;
    plot(t,u2,' :b','linewidth',2.4);
    plot(t,u3,' :m','linewidth',2.3);
    plot(t,u4,' :c','linewidth',2.2);
    plot(t,u5,' :y','linewidth',2.1);
    plot(t,u6,' :k','linewidth',2.0);
    legend({'Servo 1','Servo 2','Servo 3','Servo 4','Servo 5','Servo 6'});

    title('Atuadores')
    ylabel('Tensão(V)');
    xlabel('Tempo(s)');
    set(gca,'fontsize',10);
    set(gca,'linewidth',1);
    save("datalog.mat")
%% Etapa 3) Ajuste do datalog 
U=[u1; u2; u3; u4; u5; u6]'; % vetor com todas as entradas

datalog = iddata(Y,U,Ts); % variável com os dados de entada e saída

%% Etapa 4) Identificação do modelo 
ordem=2; % escolha do projetista. O tamanho das matrizes(Ordem) vai interfirir na eficácia do modelo
numero_estados=6*ordem;
inputs=6
output=6
%% Etapa 4.2) Modelo Arx 
%identifica um modelo arx para cada realação de entrada e saída
% e suas respectivas relações de acoplamento
% após isso encontra-se o seu equivalente em Espado de Estados (SS) 
d=size(datalog);
output=1;
inputs=1;
for i= 1:d(2)
    sys(:,:,i) =armax(datalog(:,i,i),[ordem*ones(output,inputs), ordem*ones(output,inputs), zeros(output,inputs), zeros(inputs)]);
end
for i=1:d(2)
        Gz(i,i)=tf(tf(sys(:,:,i)));
end
Gzmin=ss(Gz,'min');% Para criar o modelo no espaço de estados
[Ap,Bp,Cp,Dp,Ts]=ssdata(Gzmin);% Para obter as matrizes A B C
SS_model1=ss(Ap,Bp,Cp,Dp,Ts)
[Y1,X1]=lsim(SS_model1,U,t,zeros(size(Ap,1),1));
%% Etapa 4.2) Minimos quadrados SS
% Utiliza-se a técnica de minimos quadrados recursivo (Recursive Least Square) para encontrar as matrizes A B e C do modelo 
[A,B,C,GAMA,W,V,AIC,fit,R2_,emq_]=ident_MQR_SS_master(Y,U,Ts,ordem)
SS_model2=ss(A,B,C,0,Ts); % Modelo discreto
% [Y2,X2]=dlsim(A,B,C,0,U,[ones(numero_estados,1)*Y(1,1)]);
[Y2,X2]=lsim(SS_model2,U,t,zeros(numero_estados,1));
%% Etapa 4.3) Subespaço n4sid
% Técnica n4sid de identificação multivar

[SYS3, X0]=n4sid(datalog,numero_estados); % Identificação do modelo em Espaço de estados
SS_model3=ss(SYS3.A,SYS3.B,SYS3.C,SYS3.D,Ts); % Modelo discreto
% [Y3,X3]=lsim(SYS3.A,SYS3.B,SYS3.C,SYS3.D,U,t,zeros(numero_estados,1));
[Y3,X3]=lsim(SS_model3,U,t,zeros(numero_estados,1));

%% Etapa 5) Avaliação das respostas do modelo_1 e modelo_2 identificados
%% Etapa 5.2 validação do modelo 1
figure('units','normalized','outerposition',[0 0 0.8 1])
title("Validação do modelo2")
subplot(211),
    plot(t,y1,'r','linewidth',2); hold
    plot(t,Y1(:,1),'REPLACE_WITH_DASH_DASHr','linewidth',2.2);

    plot(t,y2,'b','linewidth',2);
    plot(t,Y1(:,2),'REPLACE_WITH_DASH_DASHb','linewidth',2.2);
    
    plot(t,y3,'m','linewidth',2);
    plot(t,Y1(:,3),'REPLACE_WITH_DASH_DASHm','linewidth',2.2);
    
    plot(t,y4,'c','linewidth',2);
    plot(t,Y1(:,4),'REPLACE_WITH_DASH_DASHc','linewidth',2.2);
    
    plot(t,y5,'y','linewidth',2);
    plot(t,Y1(:,5),'REPLACE_WITH_DASH_DASHy','linewidth',2.2);
    
    plot(t,y6,'k','linewidth',2);
    plot(t,Y1(:,6),'REPLACE_WITH_DASH_DASHk','linewidth',2.2);
    
    legend({'Y(1)_{real}','Ys(1)_{simulado}','Y(2)_{real}','Ys(2)_{simulado}','Y(3)_{real}','Ys(3)_{simulado}'...
        ,'Y(4)_{real}','Ys(4)_{simulado}','Y(5)_{real}','Ys(5)_{simulado}','Y(6)_{real}','Ys(6)_{simulado}' });

    ylabel('saída real y(t)');
subplot(212),
    plot(t,U,'linewidth',2);
    ylabel('entradas U(t)'); xlabel('Tempo (s)');
%% Etapa 5.1 validação do modelo 2
figure('units','normalized','outerposition',[0 0 0.8 1])
title("Validação do modelo1")
subplot(211),
    plot(t,y1,'r','linewidth',2); hold
    plot(t,Y2(:,1),'REPLACE_WITH_DASH_DASHr','linewidth',2.2);

    plot(t,y2,'b','linewidth',2);
    plot(t,Y2(:,2),'REPLACE_WITH_DASH_DASHb','linewidth',2.2);
    
    plot(t,y3,'m','linewidth',2);
    plot(t,Y2(:,3),'REPLACE_WITH_DASH_DASHm','linewidth',2.2);
    
    plot(t,y4,'c','linewidth',2);
    plot(t,Y2(:,4),'REPLACE_WITH_DASH_DASHc','linewidth',2.2);
    
    plot(t,y5,'y','linewidth',2);
    plot(t,Y2(:,5),'REPLACE_WITH_DASH_DASHy','linewidth',2.2);
    
    plot(t,y6,'k','linewidth',2);
    plot(t,Y2(:,6),'REPLACE_WITH_DASH_DASHk','linewidth',2.2);
    
    legend({'Y(1)_{real}','Ys(1)_{simulado}','Y(2)_{real}','Ys(2)_{simulado}','Y(3)_{real}','Ys(3)_{simulado}'...
        ,'Y(4)_{real}','Ys(4)_{simulado}','Y(5)_{real}','Ys(5)_{simulado}','Y(6)_{real}','Ys(6)_{simulado}' });

    ylabel('saída real y(t)');
subplot(212),
    plot(t,U,'linewidth',2);
    ylabel('entradas U(t)'); xlabel('Tempo (s)');
%% Etapa 5.2 validação do modelo 3
figure('units','normalized','outerposition',[0 0 0.8 1])
title("Validação do modelo2")
subplot(211),
    plot(t,y1,'r','linewidth',2); hold
    plot(t,Y3(:,1),'REPLACE_WITH_DASH_DASHr','linewidth',2.2);

    plot(t,y2,'b','linewidth',2);
    plot(t,Y3(:,2),'REPLACE_WITH_DASH_DASHb','linewidth',2.2);
    
    plot(t,y3,'m','linewidth',2);
    plot(t,Y3(:,3),'REPLACE_WITH_DASH_DASHm','linewidth',2.2);
    
    plot(t,y4,'c','linewidth',2);
    plot(t,Y3(:,4),'REPLACE_WITH_DASH_DASHc','linewidth',2.2);
    
    plot(t,y5,'y','linewidth',2);
    plot(t,Y3(:,5),'REPLACE_WITH_DASH_DASHy','linewidth',2.2);
    
    plot(t,y6,'k','linewidth',2);
    plot(t,Y3(:,6),'REPLACE_WITH_DASH_DASHk','linewidth',2.2);
    
    legend({'Y(1)_{real}','Ys(1)_{simulado}','Y(2)_{real}','Ys(2)_{simulado}','Y(3)_{real}','Ys(3)_{simulado}'...
        ,'Y(4)_{real}','Ys(4)_{simulado}','Y(5)_{real}','Ys(5)_{simulado}','Y(6)_{real}','Ys(6)_{simulado}' });

    ylabel('saída real y(t)');
subplot(212),
    plot(t,U,'linewidth',2);
    ylabel('entradas U(t)'); xlabel('Tempo (s)');
    
    

##### SOURCE END #####
--></body></html>